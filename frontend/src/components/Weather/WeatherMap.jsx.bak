import { useEffect, useRef, useState } from "react";
import mapboxgl from "mapbox-gl";
import "mapbox-gl/dist/mapbox-gl.css";
import "./WeatherMap.css";

const MAPBOX_ACCESS_TOKEN = import.meta.env.VITE_REACT_APP_MAPBOX_ACCESS_TOKEN;

// Helper to get wind direction label
const getWindDirection = (degrees) => {
  if (degrees === null || degrees === undefined) return "";
  const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
  const index = Math.round(degrees / 45) % 8;
  return directions[index];
};

const WeatherMap = ({ mapData }) => {
  const mapContainer = useRef(null);
  const map = useRef(null);
  const markerRef = useRef(null);
  const [isMapLoaded, setIsMapLoaded] = useState(false);

  // Home view = where the map should return after pan/zoom.
  // We update this whenever a new location is selected (mapData changes).
  const homeViewRef = useRef({
    center: [-95.7608, 29.5826],
    zoom: 18,
    bearing: 0,
    pitch: 0,
  });

  const INITIAL_ZOOM = 18;
  // â€œHouse-levelâ€ without being too close.
  const SELECTION_ZOOM = 17;

  const handleHomeClick = () => {
    if (!map.current) return;
    const view = homeViewRef.current;
    map.current.flyTo({
      center: view.center,
      zoom: view.zoom,
      bearing: view.bearing ?? 0,
      pitch: view.pitch ?? 0,
      essential: true,
    });
  };

  useEffect(() => {
    const centerCoordinates = mapData?.features?.[0]?.geometry?.coordinates || [
      -95.7608, 29.5826,
    ];

    if (!MAPBOX_ACCESS_TOKEN) {
      console.error(
        "Missing VITE_REACT_APP_MAPBOX_ACCESS_TOKEN in frontend/.env."
      );
      return;
    }

    // Disable telemetry to prevent "ERR_BLOCKED_BY_CLIENT" errors from ad blockers
    // Must be set before creating the map
    try {
      mapboxgl.config.TELEMETRY = false;
    } catch (e) {
      console.warn("Could not disable Mapbox telemetry", e);
    }

    if (!mapContainer.current || map.current) {
      return;
    }

    mapboxgl.accessToken = MAPBOX_ACCESS_TOKEN;
    map.current = new mapboxgl.Map({
      container: mapContainer.current,
      style: "mapbox://styles/mapbox/dark-v11",
      center: centerCoordinates,
      zoom: INITIAL_ZOOM,
      pitch: 0,
      bearing: 0,
      antialias: true,
      attributionControl: false,
    });

    homeViewRef.current = {
      center: centerCoordinates,
      zoom: INITIAL_ZOOM,
      bearing: 0,
      pitch: 0,
    };

    map.current.addControl(new mapboxgl.NavigationControl(), "top-right");

    const markerEl = document.createElement("div");
    markerEl.className = "current-location-marker";
    markerRef.current = new mapboxgl.Marker({ element: markerEl })
      .setLngLat(centerCoordinates)
      .addTo(map.current);

    map.current.on("load", () => {
      setIsMapLoaded(true);
    });

    return () => {
      if (markerRef.current) {
        markerRef.current.remove();
        markerRef.current = null;
      }
      if (map.current) {
        map.current.remove();
        map.current = null;
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (!isMapLoaded || !map.current) return;
    const centerCoordinates = mapData?.features?.[0]?.geometry?.coordinates;
    if (!centerCoordinates || centerCoordinates.length < 2) return;

    // When a user selects a specific location, zoom in more (but not too close).
    homeViewRef.current = {
      center: centerCoordinates,
      zoom: SELECTION_ZOOM,
      bearing: 0,
      pitch: 0,
    };

    map.current.flyTo({
      center: centerCoordinates,
      zoom: SELECTION_ZOOM,
      bearing: 0,
      pitch: 0,
      essential: true,
    });
    if (markerRef.current) {
      markerRef.current.setLngLat(centerCoordinates);
    }
  }, [isMapLoaded, mapData]);

  // Extract weather properties for overlay
  const weatherProps = mapData?.features?.[0]?.properties || {};
  const windSpeed = weatherProps.wind_speed;
  const windDirection = weatherProps.wind_direction;
  const precipitation = weatherProps.precip;
  const coords = mapData?.features?.[0]?.geometry?.coordinates;

  return (
    <div className="map-wrapper">
      <div ref={mapContainer} className="map-container" />

      {/* Weather Info Overlay */}
      <div className="map-weather-overlay">
        {windSpeed !== undefined && (
          <div className="map-weather-item">
            <i className="bi bi-wind"></i>
            <span>
              {Math.round(windSpeed)} mph {getWindDirection(windDirection)}
            </span>
          </div>
        )}
        {precipitation !== undefined && precipitation > 0 && (
          <div className="map-weather-item precip">
            <i className="bi bi-droplet-fill"></i>
            <span>{precipitation.toFixed(2)}"</span>
          </div>
        )}
      </div>

      {/* Coordinates Display */}
      {coords && (
        <div className="map-coords-overlay">
          <i className="bi bi-geo-alt"></i>
          <span>
            {coords[1].toFixed(4)}Â°, {coords[0].toFixed(4)}Â°
          </span>
        </div>
      )}

      <div className="map-controls-overlay">
        <button
          className="map-home-btn"
          onClick={handleHomeClick}
          title="Reset View"
          type="button"
        >
          <i className="bi bi-house-door-fill"></i>
        </button>
      </div>
    </div>
  );
};

export default WeatherMap;

